# 指図作成・共有・通知 設計 (2026-01-28)

## 目的
- 被相続人が生前に資産の分配計画（指図）を作成し、相続人へ共有する。
- 相続発生時に相続人へ適切に分配するためのルールとして参照できるようにする。

## 前提/決定事項
- 指図の作成者は被相続人（資産の所有者）のみ。
- 指図は被相続人ごとに複数作成できる。
- 指図に追加できる相続人は「受諾済み招待（invites.status=accepted）」のみ。
- 共有フラグは指図全体に1つ（相続人別の共有設定は持たない）。
- 通知はアプリ内のみ。メール送信は行わない。
- 通知は「受け取る側」に送る（招待送信→相続人、受諾/辞退→被相続人、指図共有→相続人）。
- 資産は「資産一覧」から選択して指図に紐づける。指図内で新規資産追加はしない。

## 資産/単位ルール
- AssetType は既存のまま使用（CRYPTO_WALLET / BANK_ACCOUNT / SECURITY_TOKEN / REAL_ESTATE / OTHER）。
- CRYPTO_WALLET はトークンごとに指図を作成する。
  - トークン候補は「リアルタイムでXRPL残高を取得」し、残高>0のトークンのみ選択可能。
  - 取得失敗時は選択不可（再試行のみ）。
  - トークンの分配単位は「割合」or「数量」を選択（トークン内は統一）。
- それ以外の資産タイプは「割合のみ」に固定（将来変更可能な設計前提）。
- 割合の合計が100%未満の場合は「未配分枠」を自動追加（heir未指定）。

## データモデル案（Firestore）
### plans
- `plans/{planId}`
  - `planId`
  - `ownerUid`
  - `ownerEmail`
  - `title` (必須)
  - `status`: `"DRAFT" | "SHARED" | "INACTIVE"`
  - `sharedAt`
  - `createdAt`
  - `updatedAt`
  - `heirUids`: string[]
  - `heirs`: [{ uid, email, relationLabel, relationOther }]
  - 共有時点のスナップショットとして保存

### planAssets
- `plans/{planId}/assets/{planAssetId}`
  - `planAssetId`
  - `assetId`
  - `assetType`
  - `assetLabel`
  - `token`: { currency, issuer, isNative } | null
  - `unitType`: `"PERCENT" | "AMOUNT"`
  - `allocations`: [{ heirUid | null, value, isUnallocated }]

### notifications
- `notifications/{notificationId}`
  - `receiverUid`
  - `type`: `"INVITE_SENT" | "INVITE_ACCEPTED" | "INVITE_DECLINED" | "PLAN_SHARED"`
  - `title`
  - `body`
  - `related`: { kind, id }
  - `isRead`
  - `createdAt`

## API案
- `POST /v1/plans`：指図作成（DRAFT）
- `GET /v1/plans`：指図一覧（owner）
- `GET /v1/plans/:id`：指図詳細
- `POST /v1/plans/:id/heirs`：相続人追加（受諾済み招待から）
- `POST /v1/plans/:id/assets`：資産追加（CRYPTO_WALLETはトークン単位）
- `POST /v1/plans/:id/assets/:planAssetId/allocations`：配分更新
- `POST /v1/plans/:id/share`：共有（status=SHARED、通知作成）
- `POST /v1/plans/:id/inactivate`：無効化（status=INACTIVE）
- `GET /v1/notifications`：通知一覧
- `POST /v1/notifications/:id/read`：既読
- `POST /v1/notifications/read-all`：一括既読

## 画面フロー
- 被相続人
  - 指図一覧 → 指図作成/編集
  - 相続人追加、資産追加、配分入力（割合/数量）
  - 共有/無効
- 相続人
  - 共有中の指図一覧 → 指図詳細（閲覧）
- 通知
  - 通知一覧（個別既読/一括既読）

